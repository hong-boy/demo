<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for app/util/Store.js</title>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="..\..\prettify.css"/>
    <link rel="stylesheet" href="..\..\base.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter{
            background-image:url(..\..\sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1>
            <a href="..\..\index.html">All files</a> / <a href="index.html">app/util</a> Store.js
        </h1>
        <div class='clearfix'>
            <div class='fl pad1y space-right2'>
                <span class="strong">85.71% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>42/49</span>
            </div>
            <div class='fl pad1y space-right2'>
                <span class="strong">57.14% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>8/14</span>
            </div>
            <div class='fl pad1y space-right2'>
                <span class="strong">92.86% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>13/14</span>
            </div>
            <div class='fl pad1y space-right2'>
                <span class="strong">85.71% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>42/49</span>
            </div>
        </div>
    </div>
    <div class='status-line high'></div>
<pre><table class="coverage">
    <tr>
        <td class="line-count quiet">1
            2
            3
            4
            5
            6
            7
            8
            9
            10
            11
            12
            13
            14
            15
            16
            17
            18
            19
            20
            21
            22
            23
            24
            25
            26
            27
            28
            29
            30
            31
            32
            33
            34
            35
            36
            37
            38
            39
            40
            41
            42
            43
            44
            45
            46
            47
            48
            49
            50
            51
            52
            53
            54
            55
            56
            57
            58
            59
            60
            61
            62
            63
            64
            65
            66
            67
            68
            69
            70
            71
            72
            73
            74
            75
            76
            77
            78
            79
            80
            81
            82
            83
            84
            85
            86
            87
            88
            89
            90
            91
            92
            93
            94
            95
            96
            97
            98
            99
            100
            101
            102
            103
            104
            105
            106
            107
            108
            109
            110
            111
            112
            113
            114
            115
            116
            117
            118
            119
            120
            121
            122
            123
            124
            125
            126
        </td>
        <td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">3x</span>
            <span class="cline-any cline-yes">3x</span>
            <span class="cline-any cline-yes">3x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">6x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-no">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-no">&nbsp;</span>
            <span class="cline-any cline-no">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-no">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-no">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-no">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-no">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">3x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">2x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">2x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">2x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span>
            <span class="cline-any cline-yes">1x</span>
            <span class="cline-any cline-neutral">&nbsp;</span></td>
        <td class="text"><pre class="prettyprint lang-js">//'use strict';
const Redis = require('ioredis');
const conf = require('../../config/env.js');
const redisConf = conf.redis;
const store = conf.store;
const PREFIX = 'koa:store';
&nbsp;
/**
 * Store基类（默认存储在内存中）
 */
class Store {
  constructor() {
    this._map = new Map();
    this._timers = new Map();
    console.warn('You are using memory cache. Please make sure change to "RedisStore" in production!');
  }
&nbsp;
  getID(key) {
    return `${PREFIX}:${key}`;
  }
&nbsp;
  get(key) {
    let id = this.getID(key);
    <span class="missing-if-branch" title="if path not taken">I</span>if (!this._map.has(id)) {
<span class="cstat-no" title="statement not covered">      return;</span>
    }
    return JSON.parse(this._map.get(id));
  }
&nbsp;
  set(key, value, maxAge) {
    let id = this.getID(key);
    <span class="missing-if-branch" title="if path not taken">I</span>if (this._map.has(id) &amp;&amp; <span
                class="branch-1 cbranch-no" title="branch not covered">this._timers.has(id))</span> {
      // 若之前已存在，则立即关闭定时任务
      let _timer = <span class="cstat-no" title="statement not covered">this._timers.get(id);</span>
<span class="cstat-no" title="statement not covered">      !!timer &amp;&amp; (clearTimeout(_timer));</span>
    }
    // 检测是否需要开启定时任务
    <span class="missing-if-branch" title="else path not taken">E</span>if (maxAge) {
      this._timers.set(id, setTimeout(<span class="fstat-no" title="function not covered">()</span>=&gt; {
<span class="cstat-no" title="statement not covered">        this.delete(key)</span>
      }, maxAge))
    }
    try {
      this._map.set(id, JSON.stringify(value));
    } catch (e) {
<span class="cstat-no" title="statement not covered">      console.error('Set property error:', e);</span>
    }
    return id;
  }
&nbsp;
  delete(key) {
    let id = this.getID(key);
    // 清除记录
    this._map.delete(id);
    // 关闭定时任务
    let _timer = this._timers.get(id);
    !!_timer &amp;&amp; (clearTimeout(_timer));
    this._timers.delete(id);
  }
}
&nbsp;
/**
 * RedisStore
 */
class RedisStore extends Store {
  constructor() {
    super();
    this._redis = new Redis(redisConf);
  }
&nbsp;
  async get(key) {
    let id = this.getID(key);
    let data = await this._redis.get(id);
    return JSON.parse(data);
  }
&nbsp;
  async set(key, value, maxAge) {
    let id = this.getID(key);
    try {
      await this._redis.set(id, JSON.stringify(value), 'EX', maxAge / 1000);
    } catch (e) {
<span class="cstat-no" title="statement not covered">      console.error('Set property error:', e);</span>
    }
    return id;
  }
&nbsp;
  async delete(key) {
    let id = this.getID(key);
    try {
      await this._redis.del(id);
    } catch (e) {
<span class="cstat-no" title="statement not covered">      console.error('Del property error:', e);</span>
    }
  }
}
&nbsp;
/**
 * StoreUtil 用于暴露给调用者
 */
class StoreUtil {
  constructor(store) {
    // 默认使用Store实例
    this._store = store === 'redis' ? new RedisStore() : new Store();
  }
&nbsp;
  get(key) {
    return this._store.get(key);
  }
&nbsp;
  set(key, value, maxAge) {
    return this._store.set(key, value, maxAge);
  }
&nbsp;
  del(key) {
    return this._store.delete(key);
  }
}
&nbsp;
/**
 * 返回单例
 * @type {StoreUtil}
 */
exports = module.exports = new StoreUtil(store);
// For test unit
exports.StoreUtil = StoreUtil;
&nbsp;</pre>
        </td>
    </tr>
</table></pre>
    <div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
    Code coverage
    generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Thu May 25 2017 10:43:00 GMT+0800
    (中国标准时间)
</div>
</div>
<script src="..\..\prettify.js"></script>
<script>
    window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
    };
</script>
<script src="..\..\sorter.js"></script>
</body>
</html>
